<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinoXP - Smart Timeline (Skjuler Nattetimer)</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }
        
        button {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover { background: #2980b9; }
        
        .timeline-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .timeline-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-x: auto;
        }
        
        .timeline {
            min-width: 800px;
            font-size: 12px;
        }
        
        .time-header {
            display: flex;
            margin-bottom: 10px;
            font-weight: bold;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .theatre-label-header {
            width: 150px;
            padding: 10px;
            background: #34495e;
            color: white;
            text-align: center;
        }
        
        .timeline-grid {
            flex: 1;
            display: flex;
        }
        
        .hour-header {
            flex: 1;
            padding: 10px 4px;
            background: #ecf0f1;
            text-align: center;
            border-right: 1px solid #bdc3c7;
            min-width: 60px;
        }
        
        .theatre-row {
            display: flex;
            margin-bottom: 2px;
            min-height: 60px;
            position: relative;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }
        
        .theatre-label {
            width: 150px;
            padding: 15px 10px;
            background: #3498db;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timeline-area {
            flex: 1;
            position: relative;
            background: #fafafa;
        }
        
        .screening-bar {
            position: absolute;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 11px;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 500;
            transition: all 0.2s ease;
            z-index: 10;
            height: 36px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .screening-bar.cancelled {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .screening-bar:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 20;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="pageTitle">🎬 KinoXP Smart Timeline</h1>
        <div class="controls">
            <button onclick="loadToday()">I dag</button>
            <button onclick="loadWeek()">Denne uge</button>
        </div>
        <div id="timelineInfo" class="timeline-info" style="display: none;"></div>
    </div>

    <div class="stats" id="stats" style="display: none;">
        <div class="stat-card">
            <div class="stat-number" id="totalScreenings">0</div>
            <div class="stat-label">Filmvisninger</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="activeTheatres">0</div>
            <div class="stat-label">Aktive sale</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalMovies">0</div>
            <div class="stat-label">Forskellige film</div>
        </div>
    </div>

    <div class="timeline-container">
        <div id="timeline" class="timeline">
            <div class="loading">Indlæser filmschema...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        class SmartTimelineUI {
            constructor() {
                this.visibleHours = [];
                this.loadWeek();
            }
            
            // Beregn hvilke timer der skal vises (spring nattetimer over)
            calculateVisibleHours(screenings) {
                if (!screenings || screenings.length === 0) {
                    return this.range(8, 24); // Default 08:00-24:00
                }
                
                let earliestHour = 24;
                let latestHour = 0;
                let hasNightScreenings = false;
                
                // Find faktiske screening timer
                screenings.forEach(screening => {
                    const startTime = new Date(screening.startTime);
                    const endTime = new Date(screening.endTime);
                    
                    const startHour = startTime.getHours();
                    const endHour = endTime.getHours();
                    
                    earliestHour = Math.min(earliestHour, startHour);
                    latestHour = Math.max(latestHour, endHour + (endTime.getMinutes() > 0 ? 1 : 0));
                    
                    // Tjek for nattevisninger (00:00-06:00)
                    if (startHour <= 6 || endHour <= 6) {
                        hasNightScreenings = true;
                    }
                });
                
                console.log(`🕐 Screenings range: ${earliestHour}:00 - ${latestHour}:00`);
                console.log(`🌙 Has night screenings: ${hasNightScreenings}`);
                
                if (hasNightScreenings) {
                    // Vis hele døgnet hvis der er nattevisninger
                    return this.range(0, 24);
                } else {
                    // Spring nattetimer over (00:00-07:00) og vis kun relevante timer
                    const startHour = Math.max(7, earliestHour - 1);
                    const endHour = Math.min(24, latestHour + 1);
                    return this.range(startHour, endHour);
                }
            }
            
            // Hjælpefunktion til at lave array af timer
            range(start, end) {
                const hours = [];
                for (let i = start; i < end; i++) {
                    hours.push(i);
                }
                return hours;
            }
            
            async loadToday() {
                await this.fetchAndDisplay(`${API_BASE}/gantt/today`, 'Dagens program');
            }
            
            async loadWeek() {
                await this.fetchAndDisplay(`${API_BASE}/gantt/week`, 'Ugens program');
            }
            
            async fetchAndDisplay(url, description) {
                try {
                    const response = await fetch(url);
                    const screenings = await response.json();
                    
                    console.log('📊 Screenings loaded:', screenings.length);
                    
                    // Beregn synlige timer
                    this.visibleHours = this.calculateVisibleHours(screenings);
                    
                    const timeRangeText = `${this.visibleHours[0].toString().padStart(2, '0')}:00 - ${(this.visibleHours[this.visibleHours.length-1] + 1).toString().padStart(2, '0')}:00`;
                    
                    console.log(`⚡ Visible hours: ${this.visibleHours.join(', ')}`);
                    console.log(`📺 Time range: ${timeRangeText}`);
                    
                    // Opdater UI
                    document.getElementById('pageTitle').textContent = 
                        `🎬 KinoXP Smart Timeline - ${description}`;
                    
                    document.getElementById('timelineInfo').textContent = 
                        `Viser: ${timeRangeText} (${this.visibleHours.length} timer synlige)`;
                    document.getElementById('timelineInfo').style.display = 'block';
                    
                    this.displayTimeline(screenings);
                    this.updateStats(screenings);
                    
                } catch (error) {
                    console.error('❌ Error:', error);
                    document.getElementById('timeline').innerHTML = 
                        `<div class="loading">Fejl: ${error.message}</div>`;
                }
            }
            
            displayTimeline(screenings) {
                if (!screenings || screenings.length === 0) {
                    document.getElementById('timeline').innerHTML = 
                        '<div class="loading">Ingen filmvisninger fundet</div>';
                    return;
                }
                
                // Gruppér efter teater
                const theatreGroups = {};
                screenings.forEach(screening => {
                    const theatreId = screening.theatre?.theatreId || 0;
                    const theatreName = screening.theatre?.name || 'Ukendt sal';
                    
                    if (!theatreGroups[theatreId]) {
                        theatreGroups[theatreId] = {
                            name: theatreName,
                            screenings: []
                        };
                    }
                    
                    theatreGroups[theatreId].screenings.push(screening);
                });
                
                // Byg HTML
                let html = this.createTimeHeader();
                
                Object.values(theatreGroups).forEach(theatre => {
                    html += this.createTheatreRow(theatre);
                });
                
                document.getElementById('timeline').innerHTML = html;
            }
            
            createTimeHeader() {
                let html = '<div class="time-header">';
                html += '<div class="theatre-label-header">Biografsale</div>';
                html += '<div class="timeline-grid">';
                
                this.visibleHours.forEach(hour => {
                    html += `<div class="hour-header">${hour.toString().padStart(2, '0')}:00</div>`;
                });
                
                html += '</div></div>';
                return html;
            }
            
            createTheatreRow(theatre) {
                let html = `<div class="theatre-row">`;
                html += `<div class="theatre-label">${theatre.name}</div>`;
                html += `<div class="timeline-area">`;
                
                // Tilføj screening bars
                theatre.screenings.forEach(screening => {
                    html += this.createScreeningBar(screening);
                });
                
                html += `</div></div>`;
                return html;
            }
            
            createScreeningBar(screening) {
                const startTime = new Date(screening.startTime);
                const endTime = new Date(screening.endTime);
                
                // Beregn position baseret på synlige timer
                const startPercent = this.timeToPercent(startTime);
                const endPercent = this.timeToPercent(endTime);
                const widthPercent = endPercent - startPercent;
                
                // Spring over hvis udenfor synlig range
                if (startPercent < 0 || endPercent > 100 || widthPercent <= 0) {
                    return '';
                }
                
                const statusClass = screening.status?.toLowerCase() || 'scheduled';
                const movieTitle = screening.movie?.title || 'Ukendt film';
                const timeText = `${this.formatTime(startTime)} - ${this.formatTime(endTime)}`;
                
                return `<div class="screening-bar ${statusClass}" 
                              style="left: ${startPercent}%; width: ${widthPercent}%"
                              onclick="showScreeningDetails('${movieTitle}', '${timeText}')" 
                              title="${movieTitle} - ${timeText}">
                            ${movieTitle}
                         </div>`;
            }
            
            timeToPercent(date) {
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const totalMinutes = hours * 60 + minutes;
                
                // Beregn baseret på synlige timer
                const firstVisibleHour = this.visibleHours[0];
                const lastVisibleHour = this.visibleHours[this.visibleHours.length - 1] + 1;
                
                const visibleStartMinutes = firstVisibleHour * 60;
                const visibleEndMinutes = lastVisibleHour * 60;
                const visibleTotalMinutes = visibleEndMinutes - visibleStartMinutes;
                
                const relativeMinutes = totalMinutes - visibleStartMinutes;
                
                return Math.max(0, Math.min(100, (relativeMinutes / visibleTotalMinutes) * 100));
            }
            
            formatTime(date) {
                return date.toLocaleTimeString('da-DK', {
                    hour: '2-digit', 
                    minute: '2-digit'
                });
            }
            
            updateStats(screenings) {
                const uniqueTheatres = new Set();
                const uniqueMovies = new Set();
                
                screenings.forEach(screening => {
                    if (screening.theatre?.theatreId) uniqueTheatres.add(screening.theatre.theatreId);
                    if (screening.movie?.movieId) uniqueMovies.add(screening.movie.movieId);
                });
                
                document.getElementById('totalScreenings').textContent = screenings.length;
                document.getElementById('activeTheatres').textContent = uniqueTheatres.size;
                document.getElementById('totalMovies').textContent = uniqueMovies.size;
                
                document.getElementById('stats').style.display = 'flex';
            }
        }
        
        // Global functions
        let smartUI;
        
        function loadToday() { smartUI.loadToday(); }
        function loadWeek() { smartUI.loadWeek(); }
        
        function showScreeningDetails(title, timeText) {
            alert(`🎬 ${title}\n\n⏰ ${timeText}`);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            smartUI = new SmartTimelineUI();
        });
    </script>
</body>
</html>